name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'

jobs:
  # Lint and Test
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          wok-specialists-website/package-lock.json
          wok-central/server/package-lock.json
          wok-central/client/package-lock.json
    
    - name: Install website dependencies
      working-directory: ./wok-specialists-website
      run: npm ci
    
    - name: Lint website
      working-directory: ./wok-specialists-website
      run: npm run lint
    
    - name: Build website
      working-directory: ./wok-specialists-website
      run: npm run build
    
    - name: Install server dependencies
      working-directory: ./wok-central/server
      run: npm ci
    
    - name: Run smoke tests
      run: node scripts/smoke.mjs
      timeout-minutes: 5

  # Docker Build Test
  docker-build:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker images
      run: |
        docker compose build
    
    - name: Test Docker Compose
      run: |
        docker compose up -d
        sleep 10
        docker compose ps
        node scripts/smoke.mjs --docker --website-port 3000 --game-port 3002
        docker compose down

  # Security Scan
  security:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run npm audit
      run: |
        cd wok-specialists-website && npm audit --audit-level=moderate || true
        cd ../wok-central/server && npm audit --audit-level=moderate || true
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        ignore-unfixed: true
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'

  # Deploy to Staging
  deploy-staging:
    runs-on: ubuntu-latest
    needs: [test, docker-build]
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to staging
      run: |
        echo "Deploying to staging environment..."
        # Add your staging deployment commands here
        # Example: SSH into server and run docker compose

  # Deploy to Production
  deploy-production:
    runs-on: ubuntu-latest
    needs: [test, docker-build]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to production
      run: |
        echo "Deploying to production environment..."
        # Add your production deployment commands here

  # Lighthouse CI
  lighthouse:
    runs-on: ubuntu-latest
    needs: docker-build
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Start services
      run: docker compose up -d
    
    - name: Wait for services
      run: sleep 15
    
    - name: Run Lighthouse CI
      run: |
        npm install -g @lhci/cli@0.12.x
        lhci autorun --upload.target=temporary-public-storage || echo "Lighthouse completed with warnings"
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
    
    - name: Cleanup
      run: docker compose down
